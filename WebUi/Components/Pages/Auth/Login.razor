@page "/login"


@using Common
@using Common.RequestsDto
@using Common.ResponsesDto
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.Net.Http.Json
@using Blazored.SessionStorage
@inject HttpClient HttpClient
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject ISessionStorageService SessionStorage // برای ذخیره JWT

<h3>ورود به حساب کاربری</h3>

<EditForm Model="@loginRequest" OnValidSubmit="HandleLogin"  FormName="LoginForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    
        
        <label for="email">ایمیل:</label>
        <InputText id="email" @bind-Value="loginRequest.Email" class="form-control" />
    

    
        
        <label for="password">رمز عبور:</label>
        <InputText id="password" @bind-Value="loginRequest.Password" type="password" class="form-control" />
    

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        
            @errorMessage
        
    }

    
        <button type="submit" class="btn btn-primary">ورود</button>
    
</EditForm>

@code {
    private LoginRequest loginRequest = new LoginRequest();
    private string errorMessage = string.Empty;

    // HttpClient را از طریق Name factory که در Program.cs تعریف کردید تزریق کنید
    [Inject]
    public IHttpClientFactory HttpClientFactory { get; set; }

    protected override void OnInitialized()
    {
        // در صورت نیاز، HttpClient را اینجا دریافت کنید
        HttpClient = HttpClientFactory.CreateClient("ApiHttpClient");
    }

    private async Task HandleLogin()
    {
        errorMessage = string.Empty;

        try
        {
            var response = await HttpClient.PostAsJsonAsync("api/auth/login", loginRequest);

            if (response.IsSuccessStatusCode)
            {
                var authUser = await response.Content.ReadFromJsonAsync<AuthenticationResult>();

                if (authUser != null && authUser.IsSuccess)
                {
                    // 1. JWT را در SessionStorage ذخیره کنید
                    await SessionStorage.SetItemAsync("jwtToken", authUser.Token);

                    // 2. CustomServerAuthenticationStateProvider را از وضعیت جدید مطلع کنید
                    var customAuthStateProvider = (CustomServerAuthenticationStateProvider)AuthenticationStateProvider;
                    await customAuthStateProvider.MarkUserAsAuthenticated(authUser.Token);

                    // 3. کاربر را به صفحه اصلی یا هر صفحه مورد نظر دیگر هدایت کنید
                    NavigationManager.NavigateTo("/", forceLoad: true); // forceLoad برای اطمینان از تازه‌سازی کامل Blazor context
                }
                else
                {
                    // خطا در اعتبار سنجی سمت سرور (مثلا رمز عبور اشتباه)
                    errorMessage = string.Join("\n", authUser?.Errors ?? new List<string> { "خطای نامشخص در احراز هویت." });
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized || response.StatusCode == System.Net.HttpStatusCode.BadRequest)
            {
                // این می‌تواند نشان دهنده اعتبارنامه نامعتبر باشد
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"نام کاربری یا رمز عبور اشتباه است. جزئیات: {errorContent}";
            }
            else
            {
                errorMessage = $"خطا در اتصال به سرور: {response.ReasonPhrase}";
            }
        }
        catch (HttpRequestException httpEx)
        {
            errorMessage = $"خطا در اتصال به API: {httpEx.Message}. آیا WebAPI در حال اجراست و پورت درست است؟";
            Console.WriteLine($"HttpRequestException: {httpEx.Message}");
        }
        catch (Exception ex)
        {
            errorMessage = $"خطایی رخ داد: {ex.Message}";
            Console.WriteLine($"Exception: {ex.Message}");
        }
    }
}
